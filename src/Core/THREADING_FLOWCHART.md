# FirstEngine 多线程系统执行流程图

## 系统初始化流程

```
┌─────────────────────────────────────────────────────────────┐
│                    Application Start                         │
└────────────────────────────┬────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│         ThreadManager::Initialize()                         │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  1. Create DeviceThread (High Priority)                │  │
│  │  2. Create GameThread (Normal Priority)                │  │
│  │  3. Create IOThread (Low Priority)                      │  │
│  │  4. Create PythonThread (Normal Priority)              │  │
│  │  5. Create RenderThread (Critical Priority)            │  │
│  │                                                          │  │
│  │  For each thread:                                       │  │
│  │    ├─ Create Thread object                             │  │
│  │    ├─ Initialize task queue                            │  │
│  │    ├─ Set thread priority                               │  │
│  │    └─ Start thread (ThreadMain())                       │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│              All Threads Running                            │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  DeviceThread    │  GameThread    │  IOThread        │  │
│  │  PythonThread    │  RenderThread                      │  │
│  │                                                          │  │
│  │  Each thread:                                           │  │
│  │    └─ Waiting for tasks in queue                        │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 任务执行流程

```
┌─────────────────────────────────────────────────────────────┐
│              Any Thread Calls Invoke()                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  ThreadManager::InvokeOnThread(ThreadType, task)      │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬───────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│         Get Target Thread                                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Thread* thread = GetThread(ThreadType)               │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬───────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│         Create Task and Future                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Create Promise<T>                                    │  │
│  │  Wrap task with promise completion                   │  │
│  │  Create Task(task, priority)                          │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬───────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│         Add Task to Queue                                   │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Lock queue mutex                                    │  │
│  │  Push task to priority queue                        │  │
│  │  Increment pending task count                        │  │
│  │  Unlock queue mutex                                  │  │
│  │  Notify condition variable                           │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬───────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│         Return Future                                        │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Caller can:                                           │  │
│  │    - Continue immediately (async)                      │  │
│  │    - Wait for completion (future.wait())               │  │
│  │    - Get result (future.get())                         │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 线程主循环流程

```
┌─────────────────────────────────────────────────────────────┐
│              Thread::ThreadMain()                            │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Set thread name (platform-specific)                  │  │
│  │  Set thread priority                                   │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬───────────────────────────────┘
                             │
                             ▼
                    ┌─────────┴─────────┐
                    │                   │
                    ▼                   ▼
            ┌──────────────┐    ┌──────────────┐
            │  !ShouldStop │    │  Queue Empty │
            └──────┬───────┘    └──────┬───────┘
                   │                   │
                   │  AND              │
                   └─────────┬─────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│         ProcessTasks()                                       │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  1. Lock queue mutex                                  │  │
│  │  2. Wait for condition:                               │  │
│  │       - Task available OR                             │  │
│  │       - ShouldStop signal                             │  │
│  │  3. While queue not empty:                            │  │
│  │       ├─ Pop highest priority task                    │  │
│  │       ├─ Unlock mutex                                 │  │
│  │       ├─ Execute task (try-catch)                     │  │
│  │       ├─ Increment processed count                    │  │
│  │       └─ Lock mutex for next iteration                 │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬───────────────────────────────┘
                             │
                             ▼
                    ┌─────────┴─────────┐
                    │                   │
                    ▼                   ▼
            ┌──────────────┐    ┌──────────────┐
            │  ShouldStop  │    │  More Tasks  │
            │     AND      │    │              │
            │ Queue Empty  │    │              │
            └──────┬───────┘    └──────┬───────┘
                   │                   │
                   │                   │
                   ▼                   │
            ┌──────────────┐           │
            │   Exit Loop  │           │
            └──────────────┘           │
                   │                   │
                   │                   │
                   └───────────┬───────┘
                               │
                               ▼
                    ┌──────────────────┐
                    │  Set IsRunning =   │
                    │      false        │
                    └──────────────────┘
```

## Device-Render 同步流程

```
┌─────────────────────────────────────────────────────────────┐
│         Main/Game Thread                                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  // 需要 Device 操作，但必须先等待 Render 完成        │  │
│  │                                                          │  │
│  │  // Step 1: 在 Render 线程执行 FrameGraph              │  │
│  │  auto renderFuture =                                   │  │
│  │    tm.InvokeOnThread(ThreadType::Render, []() {        │  │
│  │      BuildFrameGraph();                                │  │
│  │      ExecuteFrameGraph();                               │  │
│  │    }, TaskPriority::Critical);                         │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬───────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│         Render Thread                                         │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Task Queue: [FrameGraph Task (Critical)]             │  │
│  │                                                          │  │
│  │  ProcessTasks():                                       │  │
│  │    ├─ Pop FrameGraph task                              │  │
│  │    ├─ Execute: BuildFrameGraph()                      │  │
│  │    ├─ Execute: ExecuteFrameGraph()                    │  │
│  │    └─ Set promise value (task complete)               │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬───────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│         Main/Game Thread                                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  // Step 2: 在 Device 线程执行，等待 Render 完成       │  │
│  │  auto deviceFuture =                                   │  │
│  │    tm.InvokeOnThread(ThreadType::Device,               │  │
│  │      [&renderFuture]() {                               │  │
│  │        renderFuture.wait(); // 等待 Render 完成        │  │
│  │        ProcessDeviceOperations();                      │  │
│  │      }, TaskPriority::High);                           │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬───────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│         Device Thread                                         │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Task Queue: [Device Task (High)]                     │  │
│  │                                                          │  │
│  │  ProcessTasks():                                       │  │
│  │    ├─ Pop Device task                                 │  │
│  │    ├─ Execute: renderFuture.wait()                    │  │
│  │    │   └─ Blocks until Render thread completes         │  │
│  │    ├─ Execute: ProcessDeviceOperations()              │  │
│  │    └─ Set promise value (task complete)               │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## Barrier 同步流程

```
┌─────────────────────────────────────────────────────────────┐
│         Create Barrier(3)                                    │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  auto barrier = tm.CreateBarrier(3);                  │  │
│  │  // 3 threads must reach barrier                      │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬───────────────────────────────┘
                             │
                             ▼
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ Game Thread  │    │  IO Thread   │    │Python Thread │
│              │    │              │    │              │
│ barrier->Wait│    │ barrier->Wait│    │ barrier->Wait│
└──────┬───────┘    └──────┬───────┘    └──────┬───────┘
       │                   │                   │
       │  Count: 3         │  Count: 2         │  Count: 1
       │                   │                   │
       └───────────────────┼───────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│         All Threads Reached Barrier                          │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Count reaches 0                                     │  │
│  │  Generation increments                               │  │
│  │  Count resets to initial value                       │  │
│  │  Notify all waiting threads                          │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬───────────────────────────────┘
                             │
                             ▼
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│ Game Thread  │    │  IO Thread   │    │Python Thread │
│              │    │              │    │              │
│ Continue     │    │ Continue     │    │ Continue     │
└──────────────┘    └──────────────┘    └──────────────┘
```

## 任务优先级执行流程

```
┌─────────────────────────────────────────────────────────────┐
│         Task Queue State                                      │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Priority Queue (highest first):                       │  │
│  │    [Critical Task]  ← Next to execute                  │  │
│  │    [High Task]                                          │  │
│  │    [Normal Task]                                        │  │
│  │    [Low Task]                                           │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬───────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│         Thread ProcessTasks()                                 │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  1. Pop Critical task (highest priority)               │  │
│  │  2. Execute Critical task                              │  │
│  │  3. Pop High task                                       │  │
│  │  4. Execute High task                                   │  │
│  │  5. Pop Normal task                                     │  │
│  │  6. Execute Normal task                                 │  │
│  │  7. Pop Low task                                        │  │
│  │  8. Execute Low task                                    │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 系统关闭流程

```
┌─────────────────────────────────────────────────────────────┐
│         ThreadManager::Shutdown()                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  For each thread:                                     │  │
│  │    ├─ Set ShouldStop = true                           │  │
│  │    └─ Notify condition variable                       │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬───────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│         Each Thread                                           │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  ThreadMain() detects ShouldStop                      │  │
│  │    ├─ Process remaining tasks in queue               │  │
│  │    └─ Exit loop                                       │  │
│  └──────────────────────────────────────────────────────┘  │
└────────────────────────────┬───────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│         ThreadManager::Shutdown()                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  For each thread:                                     │  │
│  │    └─ Join thread (wait for completion)              │  │
│  │                                                       │  │
│  │  Clear all thread objects                            │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```
